---
import '../styles/global.css';
import { Dumbbell, User, LogOut } from 'lucide-react';
import { supabase } from '../lib/supabase';

interface Props {
    title: string;
}

const { title } = Astro.props;

// Verificar cookie de sesión SSR primero
const accessToken = Astro.cookies.get('sb-access-token');

if (!accessToken) {
  return Astro.redirect('/login');
}

let currentUser = null;

try {
  const supabaseUrl = 'https://deqwjyvqchtsexttwftl.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlcXdqeXZxY2h0c2V4dHR3ZnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDMzMDgsImV4cCI6MjA4NzU3OTMwOH0.soQ9wQyd2lQ-q5xi-YaARIMmTgecuErsBAgale85wpA';

  // 1. Fetch user to validate token
  const userRes = await fetch(`${supabaseUrl}/auth/v1/user`, {
    headers: {
      'apikey': supabaseAnonKey,
      'Authorization': `Bearer ${accessToken.value}`
    }
  });

  if (!userRes.ok) {
    console.error("Layout SSR Auth: Invalid token", userRes.status);
    return Astro.redirect('/login');
  }
  
  const userData = await userRes.json();
  if (!userData) {
    return Astro.redirect('/login');
  }
  
  currentUser = userData;
} catch (e) {
  console.error("Error fetching user data in layout:", e);
  return Astro.redirect('/login');
}
---

<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title} - Iron Diary</title>
</head>
<body class="bg-background text-foreground min-h-screen">
    
    <header class="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="container mx-auto flex h-14 max-w-screen-2xl items-center justify-between">
            <div class="mr-4 hidden md:flex">
                <a class="mr-6 flex items-center space-x-2" href="/dashboard-user" data-dashboard>
                    <Dumbbell className="h-6 w-6" />
                    <span class="hidden font-bold sm:inline-block">Iron Diary</span>
                </a>
                <nav class="flex items-center space-x-6 text-sm font-medium">
                    <a href="/dashboard-user" class="transition-colors hover:text-foreground/80 text-foreground">Dashboard</a>
                    <a href="/workout" class="transition-colors hover:text-foreground/80 text-foreground/60">Entrenamiento</a>
                </nav>
            </div>
            
            <!-- User menu -->
            <div class="flex items-center space-x-4">
                <div data-user-info class="flex items-center space-x-2 cursor-pointer hover:bg-accent hover:text-accent-foreground rounded-lg px-3 py-2 transition-colors">
                    <User className="h-4 w-4" />
                    <span class="text-sm font-medium" data-user-name>
                        {currentUser?.user_metadata?.full_name || currentUser?.email || 'Usuario'}
                    </span>
                </div>
                <button data-logout class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-8 px-3">
                    <LogOut className="h-4 w-4 mr-1" />
                    Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-screen-2xl px-4 py-8">
        <slot />
    </main>

    <script>
        import { sessionManager } from '../lib/session-manager.js';

        // Inicializar gestor de sesiones
        document.addEventListener('DOMContentLoaded', async () => {
            await sessionManager.init();
            sessionManager.setupUserElements();
        });
    </script>
</body>
</html>
