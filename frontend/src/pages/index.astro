---
import '../styles/global.css';
import { Dumbbell, ArrowRight, Zap, LogOut, User } from 'lucide-react';
import { supabase } from '../lib/supabase';

// SSR auth check
const accessTokenCookie = Astro.cookies.get('sb-access-token');

console.log('Index Route hit. Cookie exists:', !!accessTokenCookie);

if (!accessTokenCookie) {
  console.log('Redirecting to login: No cookie found');
  return Astro.redirect('/login');
}

let currentUser = null;
try {
  console.log('Attempting to fetch user from Supabase REST API using cookie token...');
  
  const supabaseUrl = 'https://deqwjyvqchtsexttwftl.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlcXdqeXZxY2h0c2V4dHR3ZnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDMzMDgsImV4cCI6MjA4NzU3OTMwOH0.soQ9wQyd2lQ-q5xi-YaARIMmTgecuErsBAgale85wpA';

  const response = await fetch(`${supabaseUrl}/auth/v1/user`, {
    headers: {
      'apikey': supabaseAnonKey,
      'Authorization': `Bearer ${accessTokenCookie.value}`
    }
  });

  if (!response.ok) {
    const errorText = await response.text();
    console.error('Supabase REST status:', response.status, errorText);
    return Astro.redirect('/login');
  }

  const user = await response.json();
  
  if (!user) {
    console.log('Redirecting to login: No user data returned');
    return Astro.redirect('/login');
  }
  
  currentUser = user;
  console.log('User authenticated successfully:', currentUser.email);
} catch (e) {
  console.error('Exception during SSR auth fetch:', e);
  return Astro.redirect('/login');
}

const features = [
  {
    title: "Rutinas",
    desc: "Crea y edita tus rutinas de entrenamiento con nombre y fecha.",
  },
  {
    title: "Ejercicios",
    desc: "Añade ejercicios con series, repeticiones y peso al detalle.",
  },
  {
    title: "Historial",
    desc: "Consulta todos tus entrenamientos pasados en un dashboard limpio.",
  },
  {
    title: "Progreso",
    desc: "Visualiza tu evolución y mantén el registro de tu rendimiento.",
  },
];
---
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Iron Diary - Inicio</title>
</head>
<body class="min-h-screen bg-background">
    <!-- Header flotante para usuario -->
    <header class="absolute top-0 w-full z-50 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <Dumbbell className="h-6 w-6 text-white" />
                <span class="font-bold text-lg text-white drop-shadow-md">Iron Diary</span>
            </div>
            
            <div class="flex items-center gap-4 text-white">
                <div data-user-info class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-black/20 backdrop-blur-sm border border-white/10">
                    <User className="h-4 w-4" />
                    <span data-user-name class="font-medium text-sm drop-shadow-md">
                        {currentUser?.user_metadata?.full_name || currentUser?.email || 'Usuario'}
                    </span>
                </div>
                <button data-logout class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors hover:bg-white/20 h-9 px-3 text-white backdrop-blur-sm bg-black/30 border border-white/10">
                    <LogOut className="h-4 w-4 mr-1" /> Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <!-- Hero with Gym GIF Background -->
    <section class="relative flex flex-col items-center justify-center px-4 py-24 text-center overflow-hidden min-h-screen">
        <div class="absolute inset-0 z-0">
            <img 
                src="https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=1920&h=1080&fit=crop&auto=format&q=80&sat=0" 
                alt="Gym background" 
                class="w-full h-full object-cover"
            />
            <div class="absolute inset-0 bg-gradient-to-b from-black/90 via-black/70 to-black/90"></div>
        </div>
        
        <div class="relative z-10">
            <div class="mx-auto mb-6 flex h-24 w-24 items-center justify-center rounded-3xl bg-primary shadow-2xl backdrop-blur-sm bg-primary/90">
                <Dumbbell className="h-12 w-12 text-primary-foreground" />
            </div>
            <h1 class="text-7xl tracking-wider text-white drop-shadow-2xl font-bold">DIARIO DE HIERRO</h1>
            <p class="mx-auto mt-4 max-w-lg text-lg text-white/90 drop-shadow-lg">
                Registra tus entrenamientos. Controla tu progreso. Forja tu mejor versión.
            </p>
            <div class="mt-8 flex flex-col items-center gap-3 sm:flex-row sm:justify-center">
                <a href="/dashboard-user" class="inline-flex h-11 items-center justify-center rounded-md bg-primary px-8 text-base font-medium text-primary-foreground transition-all hover:bg-primary/90 hover:scale-105 shadow-xl backdrop-blur-sm">
                    Ir al Dashboard <ArrowRight className="ml-2 h-5 w-5" />
                </a>
            </div>
        </div>
    </section>

    <!-- Features -->
    <section class="mx-auto max-w-5xl px-4 py-16 bg-background text-foreground">
        <h2 class="mb-12 text-center text-4xl font-bold">FUNCIONALIDADES</h2>
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
            {features.map((f, i) => (
                <div class="rounded-xl border border-border bg-card p-5 text-center transition-all hover:border-primary/40 hover:shadow-lg">
                    <div class="mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-xl bg-primary/10 text-primary">
                        <Zap className="h-6 w-6" />
                    </div>
                    <h3 class="mb-1 text-xl font-semibold">{f.title}</h3>
                    <p class="text-sm text-muted-foreground">{f.desc}</p>
                </div>
            ))}
        </div>
    </section>

    <!-- Tech stack -->
    <section class="border-t border-border bg-muted/50 py-12 text-center text-foreground">
        <p class="text-sm text-muted-foreground">
            Desarrollado por <span class="font-medium text-primary">Ivan Martinez</span>
        </p>
    </section>

    <script>
        import { sessionManager } from '../lib/session-manager.js';

        // Inicializar gestor de sesiones
        document.addEventListener('DOMContentLoaded', async () => {
            await sessionManager.init();
            sessionManager.setupUserElements();
        });
    </script>
</body>
</html>
