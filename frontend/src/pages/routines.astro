---
import SessionProtectedLayout from '../layouts/SessionProtectedLayout.astro';
import { PRESET_ROUTINES, getRoutinesByDifficulty, getRoutinesByCategory } from '../data/preset-routines';
import DemoBanner from '../components/DemoBanner.astro';

// Función para obtener color de dificultad
function getDifficultyColor(difficulty: string) {
    switch(difficulty) {
        case 'principiante': return 'bg-green-500/20 text-green-400 border border-green-500/30';
        case 'intermedio': return 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
        case 'avanzado': return 'bg-red-500/20 text-red-400 border border-red-500/30';
        default: return 'bg-muted text-muted-foreground';
    }
}
---

<SessionProtectedLayout title="Rutinas Predefinidas - Iron Diary">
    <DemoBanner />
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-4 text-foreground">Rutinas Predefinidas</h1>
            <p class="text-muted-foreground mb-6">
                Explora nuestras rutinas diseñadas por expertos para todos los niveles. 
                Desde principiantes hasta atletas avanzados, tenemos el plan perfecto para ti.
            </p>
        </div>

        <!-- Filtros -->
        <div class="mb-8 flex flex-wrap gap-4">
            <div class="flex gap-2">
                <button class="filter-btn px-4 py-2 rounded-lg bg-primary text-primary-foreground font-medium transition-colors hover:bg-primary/90" data-filter="all">
                    Todas
                </button>
                <button class="filter-btn px-4 py-2 rounded-lg bg-card text-card-foreground border border-border font-medium transition-colors hover:bg-accent hover:text-accent-foreground" data-filter="principiante">
                    Principiante
                </button>
                <button class="filter-btn px-4 py-2 rounded-lg bg-card text-card-foreground border border-border font-medium transition-colors hover:bg-accent hover:text-accent-foreground" data-filter="intermedio">
                    Intermedio
                </button>
                <button class="filter-btn px-4 py-2 rounded-lg bg-card text-card-foreground border border-border font-medium transition-colors hover:bg-accent hover:text-accent-foreground" data-filter="avanzado">
                    Avanzado
                </button>
            </div>
            <div class="flex gap-2">
                <button class="category-btn px-4 py-2 rounded-lg bg-card text-card-foreground border border-border font-medium transition-colors hover:bg-accent hover:text-accent-foreground" data-category="all">
                    Todas
                </button>
                <button class="category-btn px-4 py-2 rounded-lg bg-card text-card-foreground border border-border font-medium transition-colors hover:bg-accent hover:text-accent-foreground" data-category="full-body">
                    Full Body
                </button>
                <button class="category-btn px-4 py-2 rounded-lg bg-card text-card-foreground border border-border font-medium transition-colors hover:bg-accent hover:text-accent-foreground" data-category="upper-body">
                    Upper Body
                </button>
                <button class="category-btn px-4 py-2 rounded-lg bg-card text-card-foreground border border-border font-medium transition-colors hover:bg-accent hover:text-accent-foreground" data-category="lower-body">
                    Lower Body
                </button>
            </div>
        </div>

        <!-- Grid de Rutinas -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="routinesGrid">
            {
                PRESET_ROUTINES.map((routine) => (
                    <div class="routine-card bg-card rounded-lg border border-border shadow-lg p-6 hover:shadow-xl transition-all duration-300 hover:border-primary/50" 
                         data-difficulty={routine.difficulty} 
                         data-category={routine.category}>
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2 text-card-foreground">{routine.name}</h3>
                            <p class="text-muted-foreground text-sm mb-4">{routine.description}</p>
                            
                            <div class="flex gap-2 mb-4 flex-wrap">
                                <span class={`px-2 py-1 rounded text-xs font-semibold ${getDifficultyColor(routine.difficulty)}`}>
                                    {routine.difficulty}
                                </span>
                                <span class="px-2 py-1 rounded text-xs font-semibold bg-secondary text-secondary-foreground">
                                    {routine.category.replace('-', ' ').toUpperCase()}
                                </span>
                                <span class="px-2 py-1 rounded text-xs font-semibold bg-primary/10 text-primary border border-primary/20">
                                    {routine.estimatedTime} min
                                </span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h4 class="font-semibold mb-2 text-card-foreground">Ejercicios:</h4>
                            <ul class="text-sm space-y-1">
                                {routine.exercises.slice(0, 3).map((exercise) => (
                                    <li class="flex justify-between text-muted-foreground">
                                        <span>• {exercise.name}</span>
                                        <span class="text-primary font-medium">{exercise.sets}x{exercise.reps}</span>
                                    </li>
                                ))}
                                {routine.exercises.length > 3 && (
                                    <li class="text-muted-foreground">+{routine.exercises.length - 3} ejercicios más...</li>
                                )}
                            </ul>
                        </div>

                        <div class="flex gap-2">
                            <button class="use-routine-btn flex-1 bg-primary text-primary-foreground px-4 py-2 rounded font-medium transition-colors hover:bg-primary/90"
                                    data-routine-id={routine.id}>
                                Usar Rutina
                            </button>
                            <button class="view-routine-btn px-4 py-2 rounded border border-border font-medium transition-colors hover:bg-accent hover:text-accent-foreground"
                                    data-routine-id={routine.id}>
                                Ver Detalles
                            </button>
                        </div>
                    </div>
                ))
            }
        </div>
    </div>

    <!-- Modal de Detalles -->
    <div id="routineModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-card rounded-lg border border-border max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modalRoutineName" class="text-2xl font-bold text-card-foreground"></h2>
                    <button id="closeModal" class="text-muted-foreground hover:text-foreground transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p id="modalRoutineDescription" class="text-muted-foreground mb-4"></p>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="text-center bg-secondary/50 rounded-lg p-3">
                        <div id="modalDifficulty" class="text-sm font-semibold text-card-foreground"></div>
                        <div class="text-xs text-muted-foreground">Dificultad</div>
                    </div>
                    <div class="text-center bg-secondary/50 rounded-lg p-3">
                        <div id="modalCategory" class="text-sm font-semibold text-card-foreground"></div>
                        <div class="text-xs text-muted-foreground">Categoría</div>
                    </div>
                    <div class="text-center bg-secondary/50 rounded-lg p-3">
                        <div id="modalTime" class="text-sm font-semibold text-card-foreground"></div>
                        <div class="text-xs text-muted-foreground">Tiempo estimado</div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="font-semibold mb-3 text-card-foreground">Ejercicios completos:</h3>
                    <div id="modalExercises" class="space-y-2"></div>
                </div>

                <div class="flex gap-2">
                    <button id="modalUseRoutine" class="flex-1 bg-primary text-primary-foreground px-4 py-2 rounded font-medium transition-colors hover:bg-primary/90">
                        Usar esta Rutina
                    </button>
                    <button id="modalClose" class="px-4 py-2 rounded border border-border font-medium transition-colors hover:bg-accent hover:text-accent-foreground">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
</SessionProtectedLayout>

<style>
    .routine-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .routine-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(251, 146, 60, 0.15);
    }
    
    .filter-btn, .category-btn {
        transition: all 0.2s ease;
    }
    
    .filter-btn:hover, .category-btn:hover {
        transform: scale(1.05);
    }
    
    .filter-btn.bg-primary, .category-btn.bg-primary {
        box-shadow: 0 4px 6px -1px rgba(251, 146, 60, 0.3);
    }
    
    #routineModal {
        backdrop-filter: blur(8px);
    }
    
    .use-routine-btn {
        position: relative;
        overflow: hidden;
    }
    
    .use-routine-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .use-routine-btn:hover::before {
        left: 100%;
    }
</style>

<script>
    import { PRESET_ROUTINES, getRoutineById } from '../data/preset-routines.js';

    function getDifficultyColor(difficulty) {
        switch(difficulty) {
            case 'principiante': return 'bg-green-100 text-green-700';
            case 'intermedio': return 'bg-yellow-100 text-yellow-700';
            case 'avanzado': return 'bg-red-100 text-red-700';
            default: return 'bg-gray-100 text-gray-700';
        }
    }

    function filterRoutines(difficulty = 'all', category = 'all') {
        const cards = document.querySelectorAll('.routine-card');
        cards.forEach(card => {
            const cardDifficulty = card.dataset.difficulty;
            const cardCategory = card.dataset.category;
            
            const matchesDifficulty = difficulty === 'all' || cardDifficulty === difficulty;
            const matchesCategory = category === 'all' || cardCategory === category;
            
            card.style.display = matchesDifficulty && matchesCategory ? 'block' : 'none';
        });
    }

    function showRoutineModal(routineId) {
        const routine = getRoutineById(routineId);
        if (!routine) return;

        document.getElementById('modalRoutineName').textContent = routine.name;
        document.getElementById('modalRoutineDescription').textContent = routine.description;
        document.getElementById('modalDifficulty').textContent = routine.difficulty;
        document.getElementById('modalCategory').textContent = routine.category.replace('-', ' ').toUpperCase();
        document.getElementById('modalTime').textContent = routine.estimatedTime + ' min';

        const exercisesContainer = document.getElementById('modalExercises');
        exercisesContainer.innerHTML = routine.exercises.map((exercise, index) => `
            <div class="flex justify-between items-center p-3 bg-secondary/30 rounded border border-border/50">
                <div>
                    <span class="font-medium text-card-foreground">${index + 1}. ${exercise.name}</span>
                    ${exercise.rest ? `<span class="text-sm text-muted-foreground ml-2">Descanso: ${exercise.rest}s</span>` : ''}
                </div>
                <div class="text-sm font-semibold text-primary">
                    ${exercise.sets} × ${exercise.reps}
                    ${exercise.weight ? ` × ${exercise.weight}kg` : ''}
                </div>
            </div>
        `).join('');

        document.getElementById('modalUseRoutine').dataset.routineId = routineId;
        document.getElementById('routineModal').classList.remove('hidden');
    }

    function useRoutine(routineId) {
        const routine = getRoutineById(routineId);
        if (!routine) return;

        // Guardar la rutina en sessionStorage para usarla en la página de workout
        sessionStorage.setItem('selectedPresetRoutine', JSON.stringify(routine));
        
        // Redirigir a la página de workout
        window.location.href = '/workout';
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Filtros de dificultad
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Actualizar botones
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white');
                    b.classList.add('bg-gray-200', 'hover:bg-gray-300');
                });
                btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                btn.classList.add('bg-blue-500', 'text-white');

                // Filtrar rutinas
                const activeCategory = document.querySelector('.category-btn.bg-blue-500')?.dataset.category || 'all';
                filterRoutines(btn.dataset.filter, activeCategory);
            });
        });

        // Filtros de categoría
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Actualizar botones
                document.querySelectorAll('.category-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white');
                    b.classList.add('bg-gray-200', 'hover:bg-gray-300');
                });
                btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                btn.classList.add('bg-blue-500', 'text-white');

                // Filtrar rutinas
                const activeDifficulty = document.querySelector('.filter-btn.bg-blue-500')?.dataset.filter || 'all';
                filterRoutines(activeDifficulty, btn.dataset.category);
            });
        });

        // Botones de ver detalles
        document.querySelectorAll('.view-routine-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                showRoutineModal(btn.dataset.routineId);
            });
        });

        // Botones de usar rutina
        document.querySelectorAll('.use-routine-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                useRoutine(btn.dataset.routineId);
            });
        });

        // Modal
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('routineModal').classList.add('hidden');
        });

        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('routineModal').classList.add('hidden');
        });

        document.getElementById('modalUseRoutine').addEventListener('click', () => {
            useRoutine(document.getElementById('modalUseRoutine').dataset.routineId);
        });

        // Cerrar modal al hacer clic fuera
        document.getElementById('routineModal').addEventListener('click', (e) => {
            if (e.target.id === 'routineModal') {
                document.getElementById('routineModal').classList.add('hidden');
            }
        });
    });
</script>

<style>
    .routine-card {
        transition: all 0.3s ease;
    }
    
    .routine-card:hover {
        transform: translateY(-2px);
    }
    
    .filter-btn, .category-btn {
        transition: all 0.2s ease;
    }
    
    .filter-btn:hover, .category-btn:hover {
        transform: scale(1.05);
    }
</style>
